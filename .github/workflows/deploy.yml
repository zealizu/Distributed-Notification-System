name: Flask CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the repository
      - name: Checkout Code
        uses: actions/checkout@v3

      # Step 2: Set up Python
      - name: Set up Python 3.13
        uses: actions/setup-python@v4
        with:
          python-version: 3.13

      # Step 3: Set environment variables from secrets
      - name: Set Environment Variables
        run: |
          echo "RABBITMQ_HOST=${{ secrets.RABBITMQ_HOST }}" >> $GITHUB_ENV
          echo "USER_ENDPOINT=${{ secrets.USER_ENDPOINT }}" >> $GITHUB_ENV
          echo "TEMPLATE_ENDPOINT=${{ secrets.TEMPLATE_ENDPOINT }}" >> $GITHUB_ENV
          # Decode Firebase key safely into FIREBASE_KEY
          printf "%s" "${{ secrets.FIREBASE_KEY }}" | base64 --decode >> firebase_key.json
          echo "FIREBASE_KEY=$(cat firebase_key.json | tr -d '\n')" >> $GITHUB_ENV
          echo "REDIS_HOST=${{ secrets.REDIS_HOST }}" >> $GITHUB_ENV
          echo "REDIS_PORT=${{ secrets.REDIS_PORT }}" >> $GITHUB_ENV
          echo "REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}" >> $GITHUB_ENV

      # Step 4: Create and activate virtual environment, install dependencies
      - name: Install Dependencies
        run: |
          python -m venv venv
          source venv/bin/activate
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Step 5: Run tests
      - name: Run Tests
        run: |
          source venv/bin/activate
          python app.py

      # Step 6 (Optional): Print Python and project info for debugging
      - name: Debug Info
        run: |
          source venv/bin/activate
          echo "Python version: $(python --version)"
          echo "Working directory: $(pwd)"
          echo "Installed packages: $(pip list)"
